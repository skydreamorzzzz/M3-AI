一、文件核心定位
该文件是系统中 LLM/VLM 调用的本地缓存层，核心目标与实现方式如下：
核心目标：
降低实验成本：避免重复调用模型产生冗余费用；
保证实验可复现：相同请求返回一致结果；
支持批量运行：稳定复用历史调用结果，提升运行效率。
实现方式：
采用 SQLite 作为本地缓存数据库（轻量、持久化、跨平台）；
通过稳定哈希算法生成唯一缓存 key，确保请求与缓存精准映射。
二、对外接口
该文件提供两类核心接口，覆盖缓存 key 生成、缓存读写全能力：
1. 工具函数（缓存 key 生成）
make_cache_key：为模型请求生成稳定、唯一的缓存 key（核心工具函数）；
sha256_hex：对输入内容生成 SHA256 哈希值（底层哈希工具）；
_stable_json：对数据做 “排序式” JSON 序列化（保证相同内容输出一致的 JSON 字符串）。
2. 缓存类（缓存实现）
SqliteCache：基于 SQLite 的本地持久化缓存（默认使用），适用于常规实验、批量运行、成本控制场景；
NullCache：空缓存实现（不存储任何数据），适用于调试模型、成本统计、禁用缓存场景。
三、统一实现思路
缓存逻辑遵循 “构造签名→查询缓存→调用 / 写入” 的固定流程，核心是生成稳定的请求签名：
缓存核心三步：
构造 “稳定请求签名”：缓存 key 由以下 4 类信息组成（确保请求唯一性）：
task 名称：模型调用的任务标识（如 judge_constraint、verify_pair）；
model 名称：调用的模型名称（如 gpt-4v、claude-3-vision）；
payload：messages 文本 /images 路径等核心请求内容；
params：模型调用参数（如 temperature、top_p 等）。
生成唯一缓存 key：将上述信息通过 _stable_json 做排序式 JSON 序列化，再通过 sha256_hex 生成 SHA256 哈希值，确保 “相同请求→相同 key，不同参数→不同 key”。
查询 / 写入缓存：
查询 SQLite 缓存，若命中则直接返回历史结果；
若未命中，调用 LLM/VLM 获取结果，再将结果写入缓存供后续复用。
四、核心函数 / 类说明
1. make_cache_key 函数（核心工具函数）
作用：封装 “序列化 + 哈希” 逻辑，一键生成稳定缓存 key。
内部实现：
组合 task + model + payload + params 为统一字典；
调用 _stable_json 生成有序 JSON 字符串；
调用 sha256_hex 生成 SHA256 哈希值（最终缓存 key）。
核心保证：请求内容 / 参数完全一致时，输出的 key 完全相同，无随机性。
2. SqliteCache 类（核心缓存实现）
这是实际使用的缓存实现类，基于 SQLite 做持久化存储：
（1）数据库表结构
采用极简表结构，聚焦核心缓存数据：
字段名	类型	说明
key	TEXT	主键（缓存唯一标识，不可重复）
created_at	INTEGER	缓存创建时间（Unix 时间戳）
resp_text	TEXT	模型返回的原始文本输出（核心缓存内容）
resp_json	TEXT	解析后的 JSON 结果（可选，便于直接使用）
meta	TEXT	额外元信息（如 token 使用量、耗时等）
（2）主要方法
get (key)：查询缓存，命中返回 CacheHit 对象，未命中返回 None；
set (key, ...)：写入缓存，支持两种模式：
overwrite=False（默认）：若 key 已存在则忽略，保证实验结果确定性；
overwrite=True：覆盖已有记录（按需更新）；
delete (key)：删除指定 key 的缓存记录；
stats ()：返回缓存统计信息（总条数、时间范围、数据库文件路径）。
五、CacheHit 结构说明
CacheHit 是缓存命中后的结果封装结构，包含以下字段：
key：命中的缓存 key（与请求一一对应）；
created_at_unix：缓存创建时间（Unix 时间戳）；
resp_text：模型返回的原始文本输出（未加工）；
resp_json：解析后的 JSON 结果（可选）；
meta：额外信息（如 token 使用量、调用耗时等）。
六、数据库设置说明
连接 SQLite 时使用以下配置，适配实验场景需求：
PRAGMA journal_mode=WAL
PRAGMA synchronous=NORMAL
配置优点：
读多写少场景下性能更优；
支持多进程读取缓存；
推荐单进程写入，保障批量实验的安全性。
七、NullCache 类说明
作用：完全关闭缓存功能，接口与 SqliteCache 保持一致，但不保存任何数据。
适用场景：
调试模型真实调用流程；
统计模型调用的真实成本；
无需缓存的临时实验。
八、总结
该文件是整个实验系统中 “成本控制与可复现性” 的关键模块，核心职责是为所有 LLM/VLM 调用提供可复现、低成本、稳定的缓存机制。
核心特点：
稳定 key 生成：确保相同请求映射唯一缓存 key，无随机性；
SQLite 持久化：轻量、跨平台，支持批量实验复用；
支持 deterministic 模式：默认不覆盖已有缓存，保证实验结果可复现；
支持禁用缓存：通过 NullCache 快速关闭缓存，适配调试 / 成本统计场景。