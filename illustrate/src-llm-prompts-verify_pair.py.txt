一、文件核心定位
该文件是系统的两图对比验证器，作为 Verifier 模块的 LLM/VLM 后端实现，核心作用与目标如下：
输入：原始 prompt + 上一轮最优图（best 图） + 新候选图（candidate 图）；
核心判定：输出 candidate 相对 best 的质量结果（better/worse/same）；
核心目的：防止修复回归（避免 “修好一个约束，却引入新错误”），保障整体效果不降级。
二、对外接口
核心封装为一个类，提供唯一对比验证方法，输入输出规则清晰：
1. 核心类与方法
类名	核心作用	方法名	输入参数	输出类型	方法作用
LLMVerifyBackend	LLM/VLM 对比验证后端	compare	prompt_text（原始提示）、best_artifact（最优图）、candidate_artifact（候选图）、extra（可选附加信息）	Decision（字符串）	对比两张图，返回 better/worse/same 判定结果
2. 输出类型说明
Decision 为固定枚举值字符串：
better：候选图优于最优图；
worse：候选图劣于最优图；
same：两张图效果相当（或判定失败时的兜底值）。
三、核心实现思路
整体流程固定为 5 步，聚焦 “两图全局对比”，逻辑闭环且鲁棒：
提示词构造：拼接 SYSTEM_PROMPT（对比规则约束） + USER_TEMPLATE（上下文与对比目标）；
图像准备：整理两张图的路径 / URL，按「best 图 → candidate 图」顺序组成 images 列表；
模型调用：调用 LLMClient.chat(task="verify_pair", ...)，传入提示词和图像列表；
JSON 解析：通过 _safe_parse_json 容错解析 LLM 返回的 JSON 结果；
结果兜底：提取 decision 字段，非合法值则强制返回 same。
四、提示词设计逻辑
提示词设计聚焦 “全局质量把关”，避免模型聚焦单点约束，具体规则如下：
提示词类型	核心约束 / 提供内容	设计目标
SYSTEM_PROMPT	强制规则：
1. 对比两张图与原始 prompt 的整体对齐程度，而非单点约束；
2. 对新错误严格惩罚（避免 “修一处坏一片”）；
3. 无明显提升时，不鼓励改动；
4. 仅输出严格 JSON，无多余文本	让模型成为 “整体质量把关者”，杜绝回归
USER_TEMPLATE	提供核心上下文：
1. 原始 prompt 文本；
2. 明确 Image A = previous best（上一轮最优图）；
3. 明确 Image B = new candidate（新候选图）；
4. 要求模型选择更符合 prompt 的图	让模型清晰对比目标，避免混淆两张图的角色
五、compare 方法详细说明
1. 输入参数拆解
参数名	具体内容
prompt_text	用户原始自然语言描述（对比的基准依据）
best_artifact.payload	上一轮最优图的路径 / URL（对比的 “基准图”）
candidate_artifact.payload	新生成的候选图路径 / URL（对比的 “待测图”）
extra	可选附加信息（当前未使用，仅保留接口扩展性）
2. 关键模型调用
# 图像按「best → candidate」固定顺序传入，保证模型识别一致
images = [best_artifact.payload, candidate_artifact.payload]
self.client.chat(
    task="verify_pair",  # 任务标识，明确两图对比场景
    messages=messages,   # 构造好的 system + user 提示词
    images=images        # 传入两张对比图像（VLM 视觉对比）
)
核心特点：基于视觉模型（VLM）实现 “图文结合” 的全局对比，而非纯文本推理。
3. 输出与兜底规则
核心提取：解析 JSON 中的 decision 字段作为判定结果；
兜底逻辑：若 decision 不在 {better, worse, same} 范围内，强制返回 same（避免非法值导致流程中断）。
六、JSON 容错解析
通过 _safe_parse_json 函数提升模型输出不规范时的稳健性，解析逻辑分三级：
优先尝试直接调用 json.loads 解析完整输出；
若失败，用正则提取输出中的 {...} JSON 片段后重新解析；
若仍失败，抛出明确异常（便于定位模型输出问题）；
核心目的：解决模型偶尔输出解释性文本、破坏 JSON 格式的问题，保证解析稳定性。
七、系统中的位置
该模块是 refine 流程的 “质量把关层”，上下游调用链清晰：
LLMVerifyBackend（本文件） → Verifier 模块 → run_refine_loop（refine 主循环）
核心作用：为 run_refine_loop 提供 “是否用 candidate 替换 best” 的核心决策依据。
八、设计特点
全局对比：聚焦整体效果而非单点约束，杜绝 “修一处坏一片” 的回归问题；
格式强约束：强制 JSON 输出，配合容错解析，保证结果可解析；
稳健兜底：非法决策自动兜底为 same，避免流程中断；
视觉支持：基于 VLM 实现图文结合对比，贴合图像修复场景；
易替换：可直接替换为 mock 后端做 ablation 实验（对比有无验证层的效果）。
九、核心总结
该文件核心职责是 “两图全局对比”，输出 better/worse/same 判定结果，核心目标是防止修复过程中的效果回归；
设计上强调 “全局质量把关” 和 “鲁棒性”，通过强提示词约束、容错解析、非法值兜底保证流程稳定；
作为 refine 循环的 “质量守门人”，决定是否替换最优图，是保障整体修复效果的关键模块。