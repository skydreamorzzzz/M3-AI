一、文件核心定位
该文件是项目的可选 LLM 指令增强层（高级 Refiner 模块），核心特性与作用如下：
核心作用：当某条约束检查失败时，调用 LLM 生成更高质量、更精细、更局部化的编辑指令；
非必需特性：不属于基础能力，当前 pipeline 不启用该模块也能正常运行，仅作为功能增强项存在。
二、对外接口
仅提供一个核心函数，输入输出规则清晰，具体如下：
函数名	输入参数	输出类型	核心作用
generate_edit_instruction	client（LLM 客户端）、prompt_text（原始提示）、constraint（失败约束）、reason（失败原因）	str	生成优化后的编辑指令（edit_instruction）
三、模块设计目的
当前系统中 Checker 模块已能生成基础的 edit_instruction，但该模块针对 “更精准的修复需求” 设计，主要解决以下场景问题：
实现更精准的空间约束修复；
支持更强的多约束联动推理；
实现 “只改局部、最小化修改” 的细粒度编辑；
避免修复过程中破坏已有正确的元素；
简单来说，该模块将 “编辑指令生成” 从基础的 Checker 中解耦，专门负责高质量指令的生成。
四、核心实现逻辑
整体流程极简，核心为 “构造提示词 → 调用 LLM → 解析输出”，具体步骤如下：
构造 SYSTEM_PROMPT：定义 LLM 的角色和行为约束（如仅做局部修改）；
构造 USER_TEMPLATE：填充核心上下文（原始 prompt、失败的 constraint、judge 给出的失败 reason）；
调用 LLMClient.chat() 接口，向 LLM 发送拼接后的提示词；
调用 _safe_parse_json 解析 LLM 返回的 JSON 结果；
提取并返回 JSON 中的 edit_instruction 字段。
五、提示词设计逻辑
提示词分为两层设计，核心目标是让 LLM 聚焦 “局部修复” 而非 “重新生成”：
提示词类型	设计约束 / 核心内容	核心目标
SYSTEM_PROMPT	明确角色（精准修复助手）、约束规则：
1. 不重生成整图，仅做局部修改；
2. 保留已有正确元素；
3. 输出必须为严格 JSON 格式	规范 LLM 行为，避免无效 / 全局修改
USER_TEMPLATE	提供关键上下文：
1. 原始 prompt 文本；
2. 失败约束的结构化信息；
3. Judge 给出的失败原因	让 LLM 精准定位问题，聚焦 “怎么修” 而非 “重新画”
六、JSON 输出要求
强制要求 LLM 返回固定格式的 JSON，保证解析稳定性：
json
{
  "edit_instruction": "具体的局部编辑指令内容",
  "confidence": 0.0-1.0  // 置信度，0~1 区间
}
核心使用字段：系统仅读取 edit_instruction 作为最终编辑指令；
扩展字段：confidence 暂未强依赖，仅为未来功能扩展预留（如指令可信度筛选）。
七、JSON 容错解析
通过 _safe_parse_json 函数提升 LLM 输出不规范时的容错能力，解析逻辑分三级：
优先尝试直接调用 json.loads 解析完整输出；
若失败，用正则提取输出中的 {...} JSON 片段后再解析；
若仍失败，抛出异常（保证错误可感知）；
核心目的：降低因 LLM 输出格式不严格导致的模块崩溃风险。
八、设计特点
解耦性：与主 refine 流程完全解耦，不修改现有核心逻辑；
可插拔：可随时插入 Checker 或 Editor 模块中，启用 / 禁用不影响基础流程；
可验证：支持单独做 ablation 实验（对比启用 / 禁用后的效果）；
低侵入：仅增强指令生成能力，不改变原有数据结构和流程。
九、核心总结
该模块是 “高质量编辑指令生成器”，属于可选增强能力，不影响系统基础运行；
核心价值在于提升编辑指令的精准度和局部性，避免破坏已有正确元素；
是未来提升图像微调精度、开展论文对比实验的重要升级点。